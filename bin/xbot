#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace Xbot\Utils;

use Symfony\Component\Console\Application;
use Xbot\Utils\Command\CleanCommand;
use Xbot\Utils\Command\SetupCommand;
use Xbot\Utils\Command\SysinfoCommand;
use Xbot\Utils\Command\SearchCommand;
use Xbot\Utils\Command\InfoCommand;
use Xbot\Utils\Command\ConfigCommand;
use Xbot\Utils\Command\ServiceCommand;
use Xbot\Utils\Command\DatabaseCommand;
use Xbot\Utils\Command\ScheduleCommand;
use Xbot\Utils\Command\PluginCommand;
use Xbot\Utils\Command\LogCommand;
use Xbot\Utils\Plugin\PluginManager;
use Xbot\Utils\Config\ConfigManager;

$autoloadPath = dirname(__DIR__) . '/vendor/autoload.php';

if (!file_exists($autoloadPath)) {
    fwrite(STDERR, "Error: vendor/autoload.php not found. Please run: composer install\n");
    exit(1);
}

require $autoloadPath;

$app = new Application('XBot Utils', '1.0.0');
$app->addCommand(new CleanCommand());
$app->addCommand(new SetupCommand());
$app->addCommand(new SysinfoCommand());
$app->addCommand(new SearchCommand());
$app->addCommand(new InfoCommand());
$app->addCommand(new ConfigCommand());
$app->addCommand(new ServiceCommand());
$app->addCommand(new DatabaseCommand());
$app->addCommand(new ScheduleCommand());
$app->addCommand(new PluginCommand());
$app->addCommand(new LogCommand());

// Initialize configuration manager
$projectRoot = dirname(__DIR__);
$config = new ConfigManager($projectRoot);

// Initialize plugin manager and boot enabled plugins
$pluginManager = new PluginManager($projectRoot, $config);
try {
    $pluginManager->bootPlugins($app);
} catch (\Exception $e) {
    fwrite(STDERR, sprintf("Warning: Failed to load plugins: %s\n", $e->getMessage()));
}

$app->run();
